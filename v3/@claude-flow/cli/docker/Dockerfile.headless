# Ruflo v3.5 — Headless Worker Image
# ADR-020: Headless Worker Integration Architecture - Phase 3
#
# Headless workers run CLI daemon in foreground without interactive terminal.
# Used by docker-compose.workers.yml for scalable worker pools.
#
# Build:
#   docker build -t ruflo:headless -f v3/@claude-flow/cli/docker/Dockerfile.headless .
#
# Run:
#   docker run -e ANTHROPIC_API_KEY=$ANTHROPIC_API_KEY ruflo:headless

# ── Stage 1: Install ─────────────────────────────────────────────
FROM node:22-alpine AS build

RUN apk add --no-cache git

WORKDIR /install

# Install ruflo with --omit=optional to skip heavy transitive deps
RUN npm install -g ruflo@latest \
      --omit=optional \
      --ignore-scripts \
      --no-audit \
      --no-fund \
    && npm cache clean --force

# Prune heavy optional transitive deps (CLI works without them)
RUN GLOBAL_PREFIX=$(npm config get prefix) \
    && CLI_NM="${GLOBAL_PREFIX}/lib/node_modules/ruflo/node_modules" \
    && rm -rf \
      "${CLI_NM}/agentic-flow" \
      "${CLI_NM}/@opentelemetry" \
      "${CLI_NM}/onnxruntime-node" \
      "${CLI_NM}/onnxruntime-web" \
      "${CLI_NM}/onnx-proto" \
      "${CLI_NM}/@anthropic-ai" \
      "${CLI_NM}/@xenova" \
      "${CLI_NM}/agentdb" \
      "${CLI_NM}/@ruvector" \
      "${CLI_NM}/ruvector" \
      "${CLI_NM}/tiktoken" \
      "${CLI_NM}/@img" \
      "${CLI_NM}/better-sqlite3" \
      "${CLI_NM}/sharp" \
      "${CLI_NM}/@google" \
    && rm -rf \
      "${CLI_NM}/@claude-flow/embeddings" \
      "${CLI_NM}/@claude-flow/memory" \
      "${CLI_NM}/@claude-flow/codex" \
      "${CLI_NM}/@claude-flow/guidance" \
      "${CLI_NM}/@claude-flow/aidefence" \
      "${CLI_NM}/@claude-flow/plugin-gastown-bridge" \
    && NESTED="${CLI_NM}/@claude-flow/cli/node_modules" \
    && rm -rf \
      "${NESTED}/agentic-flow" \
      "${NESTED}/@ruvector" \
      "${NESTED}/agentdb" \
    && rm -rf \
      "${CLI_NM}/ruvector-onnx-embeddings-wasm" \
      "${CLI_NM}/ruvector-core-linux-x64-gnu" \
      "${CLI_NM}/@claude-flow/neural" \
      "${CLI_NM}/@grpc" \
      "${CLI_NM}/gun"

# Stage the pruned install for copying
RUN GLOBAL_PREFIX=$(npm config get prefix) \
    && mkdir -p /staged/lib /staged/bin \
    && cp -a "${GLOBAL_PREFIX}/lib/node_modules" /staged/lib/ \
    && cp -a "${GLOBAL_PREFIX}/bin/ruflo" /staged/bin/ 2>/dev/null || true \
    && cp -a "${GLOBAL_PREFIX}/bin/claude-flow" /staged/bin/ 2>/dev/null || true \
    && cp -a "${GLOBAL_PREFIX}/bin/cli" /staged/bin/ 2>/dev/null || true

# ── Stage 2: Production ──────────────────────────────────────────
FROM node:22-alpine AS production

RUN apk add --no-cache dumb-init git bash ca-certificates curl

# Non-root user
RUN addgroup -g 1001 -S ruflo \
    && adduser -S -D -H -u 1001 -h /home/ruflo -s /bin/bash -G ruflo ruflo \
    && mkdir -p /home/ruflo/.claude-flow /workspace /var/log/ruflo \
    && chown -R ruflo:ruflo /home/ruflo /workspace /var/log/ruflo

# Copy global node_modules and bin links from build stage
COPY --from=build /staged/lib/node_modules /usr/local/lib/node_modules
COPY --from=build /staged/bin/ /usr/local/bin/

# Ensure bin symlinks
RUN ln -sf /usr/local/lib/node_modules/ruflo/bin/ruflo.js /usr/local/bin/ruflo 2>/dev/null || true \
    && ln -sf /usr/local/lib/node_modules/@claude-flow/cli/bin/cli.js /usr/local/bin/claude-flow 2>/dev/null || true \
    && chmod +x /usr/local/bin/ruflo 2>/dev/null || true \
    && chmod +x /usr/local/bin/claude-flow 2>/dev/null || true

ENV NODE_ENV=production \
    CLAUDE_CODE_HEADLESS=true \
    CLAUDE_CODE_SANDBOX_MODE=strict \
    CLAUDE_FLOW_LOG_LEVEL=info \
    HOME=/home/ruflo

HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
    CMD ruflo doctor --quiet || exit 1

USER ruflo
WORKDIR /workspace

EXPOSE 3000

ENTRYPOINT ["/usr/bin/dumb-init", "--"]

# Default: start daemon in headless foreground mode
CMD ["ruflo", "daemon", "start", "--foreground", "--headless"]
